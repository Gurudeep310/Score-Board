<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Score Dashboard</title>
  <style>

    /* Dark Mode */
    body.dark-mode {
    background: linear-gradient(to right bottom, #141E30, #243B55);
    color: #eee;
    }

    body.dark-mode .container {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    }

    body.dark-mode h1, 
    body.dark-mode h2 {
    color: #ffeb3b;
    }

    body.dark-mode #teamScore {
    color: #00e676;
    }

    body.dark-mode input {
    background: rgba(255, 255, 255, 0.15);
    color: #eee;
    }

    body.dark-mode button {
    background: #2196f3;
    color: #fff;
    }
    body.dark-mode button:hover {
    background: #1976d2;
    }

    body.dark-mode #resetBtn {
    background: #ffc107;
    color: #222;
    }


    body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to right bottom, #f5f2e7, #e0dcd1); /* soft warm gradient */
    color: #333; /* easy-to-read text */
    text-align: center;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
    }

    .container {
      max-width: 900px;
      width: 100%;
      background: rgba(245, 240, 230, 0.5); /* soft cream, less glaring */
      padding: 30px;
      border-radius: 20px;
      border: 1px solid rgba(200, 180, 150, 0.3); /* subtle border */
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      border-radius: 20px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(200, 200, 200, 0.4);
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }
    h1, h2 {
      margin: 10px 0;
      font-size: 2em;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }
    #teamScore {
      font-size: 2.5em;
      font-weight: bold;
      color: #ffeb3b;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
    }
    input, button {
      width: auto;
      min-width: 120px;
      margin: 8px;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      text-align: center;
      font-size: 0.95em;
      outline: none;
      transition: all 0.3s ease-in-out;
      box-sizing: border-box;
    }
    input {
      width: 95%;
      background: rgba(255, 255, 255, 0.85);
      color: #333;
      font-weight: 500;
    }
    button {
      cursor: pointer;
      background: #a88f6f;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }
    button:hover {
      background: #8c7153;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    .hidden {
      display: none;
    }
    .player-list {
      text-align: left;
      margin-top: 20px;
      overflow-y: auto;
      max-height: 500px;
      padding-right: 15px;
      position: relative;
    }
    .player {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 10px;
      margin: 8px 0;
      font-size: 1em;
      transition: all 0.7s ease-in-out;
      opacity: 1;
    }
    .delete-btn {
        background-color: #e53e3e;
        color: #ffffff;
        border: none;
        border-radius: 9999px;
        width: 2rem;
        height: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .delete-btn:hover {
      background: #e65c50;
    }
    #resetBtn {
      background: #ffeb3b;
      color: #333;
    }
    #resetBtn:hover {
      background: #e6d836;
    }

    .player.highlight {
    background-color: rgba(255, 235, 59, 0.7);
    transition: background-color 0.5s ease;
    }


    /* Fire container */
    .fire {
        animation: fire-animation 0.5s infinite alternate;
        display: inline-block;
    }

    /* Fire flicker animation */
    @keyframes fire-animation {
        from {
            transform: scale(1);
            opacity: 1;
            content: "🔥";
        }
        to {
            transform: scale(1.2);
            opacity: 0.8;
            content: "✨";
        }
    }

    /* Chat Icon */
    #chatIcon {
      position: fixed;
      left: 20px;
      bottom: 20px;
      width: 55px;
      height: 55px;
      background: #ff6f61;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 28px;
      color: #fff;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
      z-index: 1001;
    }
    #chatIcon:hover {
      transform: scale(1.1) rotate(10deg);
    }

    /* Chat Panel */
    .chat-message {
      margin-bottom: 10px;
      text-align: left;
    }
    .user-message { font-weight: bold; color: #ffeb3b; }
    .bot-message { font-style: italic; color: #89f7fe; }

    /* Smoke animation for chat panel */
    #smokeContainer {
        position: fixed;
        bottom: 0;
        left: 20px;       /* LHS */
        width: 400px;     /* wider for big chat */
        height: 600px;    /* taller for larger interface */
        pointer-events: none;
        overflow: visible;
        z-index: 999;
    }

    /* Smoke particle */
    .smoke {
        position: absolute;
        bottom: 0;
        width: 25px;
        height: 25px;
        background: rgba(255,255,255,0.25);
        border-radius: 50%;
        filter: blur(12px);
        animation: rise 30s linear forwards; /* changed duration */
        opacity: 0;
    }

    @keyframes rise {
        0% { transform: translateY(0) scale(0.4); opacity: 0.3; }
        20% { opacity: 0.5; }
        50% { opacity: 0.4; }
        80% { opacity: 0.3; }
        100% { transform: translateY(-800px) scale(2); opacity: 0.15; }
    }
    /* Chat panel hidden initially */

    #chatPanel {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 400px;      /* bigger width */
        max-height: 600px; /* bigger height */
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px 20px 70px;
        color: #fff;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        opacity: 0;
        transform: scale(0.5);
        z-index: 1000;
        pointer-events: auto;
    }

    /* Animation after smoke */
    #chatPanel.show {
        animation: appearLHS 0.8s forwards ease-out;
    }

  #suggestionBox {
      position: absolute;
      bottom: 60px; /* Position above the input container */
      left: 20px;
      right: 20px;
      background: #2b3e50;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1002;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background 0.2s;
      color: #eee;
  }
  .suggestion-item:hover {
      background: rgba(255, 255, 255, 0.1);
  }

    @keyframes appearLHS {
        0% {
            transform: scale(0.5) translateY(50px);
            opacity: 0;
            filter: blur(10px);
        }
        60% {
            transform: scale(1.05) translateY(-10px);
            opacity: 1;
            filter: blur(2px);
        }
        100% {
            transform: scale(1) translateY(0);
            opacity: 1;
            filter: blur(0);
        }
    }

    @keyframes puff {
        0% {
            transform: scale(1);
            opacity: 1;
            filter: blur(0);
        }
        50% {
            transform: scale(1.2);
            opacity: 0.7;
            filter: blur(2px);
        }
        100% {
            transform: scale(0.3);
            opacity: 0;
            filter: blur(8px);
        }
    }


    #chatPanel.open {
    animation: smokeUp 0.6s forwards ease-out;
    }


    /* Apply puff */
    #chatPanel.puff {
        animation: puff 0.6s forwards ease-out;
    }

    /* Adjust input container for bottom */
    #chatInputContainer {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.2);
    border-radius: 6px;
    padding: 5px;
    box-sizing: border-box;
    }
    

    #chatbox {
      flex-grow: 1;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      text-align: left;
      box-sizing: border-box;
    }

    #chatInput {
      flex-grow: 1;
      margin: 0;
      border-radius: 4px;
      padding: 8px;
    }
    #sendChatBtn {
      margin: 0 0 0 8px;
      border-radius: 4px;
    }

    /* Chat header */
    #chatHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    #chatHeader h3 {
      margin: 0;
      font-size: 1em;
    }
    .chat-control-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #ccc;
    font-size: 12px;       /* smaller icon size */
    cursor: pointer;
    margin-left: 6px;
    width: 24px;           /* fixed square size */
    height: 24px;
    border-radius: 4px;    /* small rounding (or 0 for sharp corners) */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;            /* ensures square shape */
    transition: all 0.2s ease;
    }

    .chat-control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    color: #fff;
    }

    /* Dashboard player cards */
    #dashboardCards {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
    }

    .player-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        border-radius: 15px;
        padding: 20px;
        width: 150px;
        text-align: center;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        position: relative;
        transition: transform 0.3s, background 0.3s;
    }

    .player-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.25);
    }

    /* Medal positions */
    .player-card .medal {
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 1.5em;
    }

    /* Score styling */
    .player-card .score {
        font-size: 1.5em;
        margin-top: 10px;
        color: #ffeb3b;
    }

    .firework {
        width: 5px;
        height: 5px;
        background: radial-gradient(circle, #ff0, #f00);
        border-radius: 50%;
        position: absolute;
        animation: explode 0.8s ease-out forwards;
    }

    @keyframes explode {
        0% { transform: scale(0); opacity: 1; }
        50% { transform: scale(1.5); opacity: 1; }
        100% { transform: scale(3); opacity: 0; }
    }

    /* The switch - the box around the slider */
    .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 24px;
        margin-left: 6px;
    }

    /* Hide default HTML checkbox */
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    /* The slider */
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
    }

    input:checked + .slider {
        background-color: #2196F3;
    }

    input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
        -webkit-transform: translateX(16px);
        -ms-transform: translateX(16px);
        transform: translateX(16px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 34px;
    }

    .slider.round:before {
        border-radius: 50%;
    }
    .suggestion-toggle-container {
        display: flex;
        align-items: center;
        gap: 10px; /* Adds space between the label and the switch */
        margin-right: 15px; /* Adjusts spacing from other controls */
    }

    .toggle-label {
        font-size: 14px;
        color: #ccc;
        white-space: nowrap; /* Prevents the text from wrapping */
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
<div class="container">
  <h1>Coins Dashboard 💰</h1>
  <h2>Current Score: <span id="teamScore">0</span></h2>
  <div class="player-list" id="players"></div>

    <div>
        <button onclick="toggleSection('addSection')">Add Player ➕</button>
        <button onclick="toggleSection('updateSection')">Update Score 📝</button>
        <button onclick="toggleSection('adjustTotalSection')">Adjust Total ⚙️</button>
        <button onclick="showDashboard()">Show Dashboard ✨</button>
        <button id="resetBtn" onclick="resetData()">Reset All Data 🗑️</button>
        <button id="themeToggle">🌙 Dark Mode</button>
    </div>


  <div id="addSection" class="hidden">
    <h3>Add Player</h3>
    <input type="text" id="playerName" placeholder="Player Name">
    <input type="number" id="playerScore" placeholder="Initial Score">
    <button onclick="addPlayer()">Add</button>
  </div>

  <div id="updateSection" class="hidden">
    <h3>Update Score</h3>
    <input type="number" id="updatePlayerId" placeholder="Player ID">
    <input type="number" id="updateScore" placeholder="Score Change (+/-)">
    <button onclick="updateScore()">Update</button>
  </div>

  <div id="adjustTotalSection" class="hidden">
    <h3>Adjust Current Score</h3>
    <input type="number" id="adjustTotalScore" placeholder="New Total Score">
    <button onclick="adjustTotalScore()">Set Score</button>
  </div>
</div>

<!-- Floating Chat Icon -->
<div id="chatIcon">💬</div>

<!-- Slide-out Chat Panel -->
<div id="chatPanel">
  <div id="chatHeader">
    <h3>Chat with Bot 🤖</h3>
    <div>
      <button id="minimizeChat" class="chat-control-btn" title="Minimize">_</button>
      <button id="closeChat" class="chat-control-btn" title="Close">✕</button>
      <div class="suggestion-toggle-container">
          <span class="toggle-label">Suggestions</span>
          <label class="switch">
              <input type="checkbox" id="suggestionToggle">
              <span class="slider round"></span>
          </label>
      </div>
    </div>
  </div>
  <div id="chatbox"></div>
  <div id="chatInputContainer">
    <input type="text" id="chatInput" placeholder="Ask something..." onkeydown="if(event.keyCode === 13) sendChat()">
    <div id="suggestionBox" class="hidden"></div>
    <button id="sendChatBtn" onclick="sendChat()">Send</button>
  </div>
</div>

<div id="smokeContainer"></div>

<div id="dashboardCards" class="hidden"></div>

<canvas id="confettiCanvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:2000;"></canvas>

<script>
  let players = JSON.parse(localStorage.getItem('players')) || [];
  let totalScore = parseInt(localStorage.getItem('totalScore')) || 0;
  let playerIdCounter = parseInt(localStorage.getItem('playerIdCounter')) || 1;
  let suggestionsEnabled = JSON.parse(localStorage.getItem('suggestionsEnabled')) !== false;
  const suggestionToggle = document.getElementById("suggestionToggle");

  // Set initial toggle state based on localStorage
  suggestionToggle.checked = suggestionsEnabled;

  // Add a change event listener to the checkbox
  suggestionToggle.addEventListener("change", (event) => {
      suggestionsEnabled = event.target.checked;
      localStorage.setItem('suggestionsEnabled', suggestionsEnabled);
      // Removed the line suggestionBox.classList.add("hidden");
  });

  document.getElementById("teamScore").innerText = totalScore.toLocaleString();

    // Hotkey to toggle chat (e.g., "C" key)
    document.addEventListener("keydown", (event) => {
        if (event.key.toLowerCase() === "`") {
            if (!chatPanel.classList.contains("show")) {
                // Open chat with smoke effect
                createSmoke(() => {
                    chatPanel.classList.add("show");
                });
                chatIcon.style.display = "none";
            } else {
                // Close chat with puff
                closeChatWithPuff();
            }
        }
    });

   
    function createSmoke(callback) {
        const smokeContainer = document.getElementById("smokeContainer");
        let particles = 12;  // more particles for bigger smoke
        for (let i = 0; i < particles; i++) {
            const smoke = document.createElement("div");
            smoke.className = "smoke";
            smoke.style.left = Math.random() * 80 + "%"; // within container
            smoke.style.animationDuration = 2 + Math.random() * 2 + "s";
            smokeContainer.appendChild(smoke);

            smoke.addEventListener("animationend", () => smoke.remove());
        }

        // Show chat after 1s
        setTimeout(() => {
            callback();
        }, 1000);
    }

function closeChatWithPuff() {
        chatPanel.classList.add("puff");

        // After puff animation ends, reset
        chatPanel.addEventListener("animationend", () => {
            chatPanel.classList.remove("puff", "show");
            chatIcon.style.display = "flex";  // show icon again
        }, { once: true });
    }

  function toggleSection(sectionId) {
    document.querySelectorAll('.hidden').forEach(el => el.classList.add('hidden'));
    document.getElementById(sectionId).classList.remove('hidden');
  }

  function addPlayer() {
      let name = document.getElementById("playerName").value.trim();
      let score = parseInt(document.getElementById("playerScore").value) || 0;
      if (!name) { alert("Please enter a valid player name."); return; }
      let newPlayer = { id: playerIdCounter++, name: name, score: score };
      players.push(newPlayer);
      totalScore += score;
      saveAndUpdate();
      document.getElementById("playerName").value = "";
      document.getElementById("playerScore").value = "";
    }

  function adjustTotalScore() {
    let newScore = parseInt(document.getElementById("adjustTotalScore").value);
    if (isNaN(newScore)) { alert("Please enter a valid number."); return; }
    totalScore = newScore;
    saveAndUpdate();
    document.getElementById("adjustTotalScore").value = "";
  }

    function showDashboard() {
        // Hide action buttons except reset
        document.querySelectorAll('.container button').forEach(el => {
            if (el.id !== 'resetBtn') el.style.display = 'none';
        });
        document.getElementById('resetBtn').style.display = 'inline-block';

        // Hide optional sections
        document.getElementById("addSection").classList.add("hidden");
        document.getElementById("updateSection").classList.add("hidden");
        document.getElementById("adjustTotalSection").classList.add("hidden");

        // Change background for dashboard
        document.body.style.background = "linear-gradient(to right, #ff7e5f, #feb47b)";
        document.querySelector('.container').style.background = "rgba(0,0,0,0.3)";
        document.body.classList.add('dashboard-view-mode');

        // Update player cards
        updateDashboardCards();

        // Launch celebration effects
        launchConfetti();
        launchFireworks();

        // Optionally, show overall stats
        showDashboardStats();
    }

  function updateDashboardCards() {
        const container = document.getElementById("dashboardCards");
        container.innerHTML = "";

        // Sort players by score
        const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

        sortedPlayers.forEach((player, index) => {
            const card = document.createElement("div");
            card.className = "player-card";

            // Add medal for top 3
            let medal = "";
            if (index === 0) medal = "🥇";
            else if (index === 1) medal = "🥈";
            else if (index === 2) medal = "🥉";

            card.innerHTML = `
                <div class="medal">${medal}</div>
                <div class="name">${player.name}</div>
                <div class="score">${player.score.toLocaleString()}</div>
            `;
            container.appendChild(card);
        });
    }

  function updateScore() {
    let playerId = parseInt(document.getElementById("updatePlayerId").value);
    let scoreChange = parseInt(document.getElementById("updateScore").value);
    if (isNaN(playerId) || isNaN(scoreChange)) { alert("Invalid inputs."); return; }
    let player = players.find(p => p.id === playerId);
    if (!player) { alert("Player not found."); return; }
    player.score += scoreChange;
    totalScore += scoreChange;
    saveAndUpdate();
    document.getElementById("updatePlayerId").value = "";
    document.getElementById("updateScore").value = "";
  }

  function deletePlayer(id) {
    if (confirm("Are you sure you want to delete this player?")) {
      let playerIndex = players.findIndex(p => p.id === id);
      if (playerIndex > -1) {
        totalScore -= players[playerIndex].score;
        players.splice(playerIndex, 1);
        saveAndUpdate();
      }
    }
  }

  function resetData() {
    if (confirm("Are you sure you want to reset all data?")) {
      localStorage.clear();
      players = [];
      totalScore = 0;
      playerIdCounter = 1;
      saveAndUpdate();
    }
  }

    function saveAndUpdate() {
        localStorage.setItem('players', JSON.stringify(players));
        localStorage.setItem('totalScore', totalScore);
        localStorage.setItem('playerIdCounter', playerIdCounter);
        document.getElementById("teamScore").innerText = totalScore.toLocaleString();
        updatePlayers(); // ✅ leaderboard updates + animations + alerts
    }


    // function updatePlayers() {
    //     players.sort((a, b) => b.score - a.score);
    //     const container = document.getElementById("players");
    //     container.innerHTML = "";

    //     players.forEach((player, index) => {
    //         let rankEmoji = "🔹";
    //         if (index === 0) rankEmoji = "🥇";
    //         else if (index === 1) rankEmoji = "🥈";
    //         else if (index === 2) rankEmoji = "🥉";

    //         const div = document.createElement("div");
    //         div.className = "player";
    //         div.innerHTML = `<span>${rankEmoji} Rank ${index + 1} | ID ${player.id} | ${player.name} - ${player.score}</span>
    //                         <button class="delete-btn" onclick="deletePlayer(${player.id})">x</button>`;

    //         // Add fire animation next to top player
    //         if (index === 0) {
    //             const fire = document.createElement("span");
    //             fire.className = "fire"; // CSS class for fire animation
    //             fire.textContent = "🔥"; // Add the fire emoji to the span
    //             div.querySelector("span").appendChild(fire);
    //         }

    //         container.appendChild(div);
    //     });
    // }

    function updatePlayers() {
        const container = document.getElementById("players");
        const oldPositions = {};

        // Record old positions
        document.querySelectorAll(".player").forEach(el => {
            oldPositions[el.dataset.id] = el.offsetTop;
        });

        // Sort players by score
        players.sort((a, b) => b.score - a.score);

        container.innerHTML = "";

        players.forEach((player, index) => {
            const div = document.createElement("div");
            div.className = "player";
            div.dataset.id = player.id;
            let rankEmoji = "🔹";
            if (index === 0) rankEmoji = "🥇";
            else if (index === 1) rankEmoji = "🥈";
            else if (index === 2) rankEmoji = "🥉";

            div.innerHTML = `<span>${rankEmoji} Rank ${index + 1} | ID ${player.id} | ${player.name} - ${player.score}</span>
                            <button class="delete-btn" onclick="deletePlayer(${player.id})">x</button>`;

            // Fire for top player
            if (index === 0) {
                const fire = document.createElement("span");
                fire.className = "fire";
                fire.textContent = "🔥";
                div.querySelector("span").appendChild(fire);
            }

            container.appendChild(div);
        });

        // Animate leaderboard movement
        document.querySelectorAll(".player").forEach(el => {
            const id = el.dataset.id;
            const oldTop = oldPositions[id] || el.offsetTop;
            const newTop = el.offsetTop;
            const delta = oldTop - newTop;

            if (delta) {
                el.style.transition = "none";
                el.style.transform = `translateY(${delta}px)`;

                requestAnimationFrame(() => {
                    el.style.transition = "transform 0.5s ease";
                    el.style.transform = "translateY(0)";
                });
            }
        });

        // Check for close leads and milestones
        checkLeaderboardAlerts();
    }

    function checkLeaderboardAlerts() {
        if (players.length < 2) return;

        const sorted = [...players].sort((a, b) => b.score - a.score);
        const top = sorted[0];
        const second = sorted[1];

        // Close lead alert (within 10 points)
        const gapThreshold = 10;
        if (top.score - second.score <= gapThreshold) {
            highlightPlayers([top.id, second.id]);
            console.log(`⚠️ ${second.name} is very close to ${top.name}!`);
        }

        // Total score milestones
        const milestones = [100, 500, 1000];
        milestones.forEach(milestone => {
            if (totalScore >= milestone && !localStorage.getItem(`milestone_${milestone}`)) {
                localStorage.setItem(`milestone_${milestone}`, "1");
                console.log(`🎉 Total score reached ${milestone}!`);
                launchConfetti(); // trigger celebration
            }
        });
    }

// Highlight effect for players
function highlightPlayers(ids) {
    ids.forEach(id => {
        const el = document.querySelector(`.player[data-id='${id}']`);
        if (el) {
            el.classList.add("highlight");
            setTimeout(() => el.classList.remove("highlight"), 2000);
        }
    });
}

// Add highlight effect
function highlightPlayers(ids) {
    ids.forEach(id => {
        const el = document.querySelector(`.player[data-id='${id}']`);
        if (el) {
            el.classList.add("highlight");
            setTimeout(() => el.classList.remove("highlight"), 2000);
        }
    });
}


    function launchConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const confettiCount = 150;
        const confetti = [];

        for (let i = 0; i < confettiCount; i++) {
            confetti.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                r: Math.random() * 6 + 4,
                d: Math.random() * confettiCount,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                tilt: Math.random() * 10 - 10,
                tiltAngleIncremental: Math.random() * 0.07 + 0.05,
                tiltAngle: 0
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            confetti.forEach((c, i) => {
                ctx.beginPath();
                ctx.lineWidth = c.r / 2;
                ctx.strokeStyle = c.color;
                ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
                ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
                ctx.stroke();
            });
            update();
        }

        function update() {
            confetti.forEach((c, i) => {
                c.tiltAngle += c.tiltAngleIncremental;
                c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
                c.x += Math.sin(c.d);
                c.tilt = Math.sin(c.tiltAngle) * 15;

                if (c.y > canvas.height) {
                    c.y = -10;
                    c.x = Math.random() * canvas.width;
                }
            });
        }

        const interval = setInterval(draw, 20);

        // Stop confetti after 5 seconds
        setTimeout(() => {
            clearInterval(interval);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }, 5000);
    }

    function launchFireworks() {
    const body = document.body;
    for (let i = 0; i < 5; i++) {
        const firework = document.createElement('div');
        firework.className = 'firework';
        firework.style.left = Math.random() * window.innerWidth + 'px';
        firework.style.top = Math.random() * window.innerHeight / 2 + 'px';
        body.appendChild(firework);

        setTimeout(() => firework.remove(), 2000); // remove after animation
    }
}

      // Chatbot
    // A list of common chat commands/queries for suggestions
    // A list of static chat commands/queries for suggestions
    const staticSuggestions = [
      "help",
      "show all players",
      "who is the leader?",
      "what is the total score?",
      "show me the average score",
      "who has more than 50 points?",
      "bar chart",
      "pie chart",
      "/add name=... score=...",
      "/update id=... score=...",
      "/adjust total=...",
      "/clear",
      "/dashboard",
      "/reset"
    ];

    function getDynamicSuggestions() {
      let dynamicSuggestions = [...staticSuggestions]; // Start with the static list

      // Add suggestions for each player
      players.forEach(player => {
        // Suggest score lookup by name
        dynamicSuggestions.push(player.name);
        dynamicSuggestions.push(player.id);
        dynamicSuggestions.push(`what is ${player.name}'s score?`);
        // Suggest score lookup by ID (for update commands)
        dynamicSuggestions.push(`/update id=${player.id} score=...`);
      });

      return dynamicSuggestions;
    }

    // Hide suggestions when clicking outside
    document.addEventListener("click", (event) => {
      if (!chatInput.contains(event.target) && !suggestionBox.contains(event.target)) {
        suggestionBox.classList.add("hidden");
      }
    });

    const chatInput = document.getElementById("chatInput");
    const suggestionBox = document.getElementById("suggestionBox");

    // Listen for user input
    chatInput.addEventListener("input", () => {
      const query = chatInput.value.toLowerCase();
      suggestionBox.innerHTML = ""; // Clear old suggestions

      if (suggestionsEnabled && query.length > 0) {
        // Get the combined list of static and dynamic suggestions
        const allSuggestions = getDynamicSuggestions(); 
        
        const filteredSuggestions = allSuggestions.filter(s =>
          s.toLowerCase().includes(query)
        );

        if (filteredSuggestions.length > 0) {
          suggestionBox.classList.remove("hidden");
          filteredSuggestions.forEach(s => {
            const item = document.createElement("div");
            item.className = "suggestion-item";
            item.innerText = s;
            item.addEventListener("click", () => {
              chatInput.value = s;
              suggestionBox.classList.add("hidden");
              chatInput.focus();
            });
            suggestionBox.appendChild(item);
          });
        } else {
          suggestionBox.classList.add("hidden");
        }
      } else {
        suggestionBox.classList.add("hidden");
      }
    });

    function sendChat() {
    const chatInput = document.getElementById("chatInput");
    const chatbox = document.getElementById("chatbox");
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    // Show user message
    const userMsgDiv = document.createElement("div");
    userMsgDiv.className = "chat-message user-message";
    userMsgDiv.innerText = "You: " + userMessage;
    chatbox.appendChild(userMsgDiv);
    chatbox.scrollTop = chatbox.scrollHeight;

    chatInput.value = "";

    // Show "typing..."
    const typingDiv = document.createElement("div");
    typingDiv.className = "chat-message bot-message typing";
    typingDiv.innerText = "Bot is typing...";
    chatbox.appendChild(typingDiv);
    chatbox.scrollTop = chatbox.scrollHeight;

    // Get bot response
    const botResponse = getBotResponse(userMessage);

    setTimeout(() => {
        typingDiv.remove();

        // ✅ If response is a chart
        if (typeof botResponse === "object" && botResponse.type === "bar") {
        const chartDiv = document.createElement("div");
        chartDiv.className = "chat-message bot-message";
        chartDiv.innerHTML = `<p>📊 Here’s the bar chart:</p>
                                <canvas id="chart${Date.now()}" width="300" height="200"></canvas>`;
        chatbox.appendChild(chartDiv);

        const ctx = chartDiv.querySelector("canvas").getContext("2d");

        new Chart(ctx, {
            type: 'bar',
            data: {
            labels: botResponse.data.map(p => p.name),
            datasets: [{
                label: "Scores",
                data: botResponse.data.map(p => p.score),
                backgroundColor: "rgba(255, 206, 86, 0.7)"
            }]
            },
            options: {
            responsive: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
            }
        });
        } 

        if (typeof botResponse === "object" && botResponse.type === "pie") {
  const chartDiv = document.createElement("div");
  chartDiv.className = "chat-message bot-message";
  chartDiv.innerHTML = `<p>📊 Here’s the pie chart:</p>
                        <canvas id="chart${Date.now()}" width="300" height="200"></canvas>`;
  chatbox.appendChild(chartDiv);

  const ctx = chartDiv.querySelector("canvas").getContext("2d");
  const dataValues = botResponse.data.map(p => p.score);
  const total = dataValues.reduce((a,b) => a + b, 0);

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: botResponse.data.map(p => p.name),
      datasets: [{
        data: dataValues,
        backgroundColor: botResponse.data.map((_, i) =>
          `hsl(${(i*60)%360}, 70%, 60%)`
        )
      }]
    },
    options: {
      responsive: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const percentage = ((value / total) * 100).toFixed(1);
              return `${context.label}: ${value} (${percentage}%)`;
            }
          }
        },
        datalabels: {
          formatter: (value, ctx) => {
            const percentage = ((value / total) * 100).toFixed(1);
            return `${percentage}%`;
          },
          color: '#fff',
          font: { weight: 'bold', size: 12 }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

        // ✅ Otherwise, stream text like before
        else {
        const botMsgDiv = document.createElement("div");
        botMsgDiv.className = "chat-message bot-message";
        botMsgDiv.innerText = "Bot: ";
        chatbox.appendChild(botMsgDiv);
        chatbox.scrollTop = chatbox.scrollHeight;

        let i = 0;
        const responseText = String(botResponse);
        function typeWriter() {
            if (i < responseText.length) {
            let char = responseText.charAt(i);
            if (char === " ") {
                botMsgDiv.innerHTML += "&nbsp;";
            } else if (char === "\n") {
                botMsgDiv.innerHTML += "<br>";
            } else {
                botMsgDiv.innerHTML += char;
            }
            i++;
            chatbox.scrollTop = chatbox.scrollHeight;
            setTimeout(typeWriter, 25);
            }
        }
        typeWriter();
        }
    }, 500);
    }


    function getBotResponse(message) {
    message = message.toLowerCase();

    if (message.includes("bar chart") || message.includes("graph")) {
        if (players.length === 0) return "⚠️ No players yet.";
        return { type: "bar", data: players };
    }

    if (message.includes("pie chart")) {
        if (players.length === 0) return "⚠️ No players yet.";
        return { type: "pie", data: players };
    }

    if (message.startsWith("/clear")) {
    chatbox.innerHTML = ""; // clear all messages
    return "🧹 Chat cleared!";
    }
    // Greetings & help
    if (message.includes("hello") || message.includes("hi")) 
        return "👋 Hi there! How can I help you today?";
    
    if (message.includes("help")) 
        return "📘 You can ask me the following:\n\n" +

            "👋 **General**\n" +
            "- Hello / Hi\n" +
            "- Help\n" +
            "- Rules\n\n" +

            "👥 **Players**\n" +
            "- Add player\n" +
            "- Update score\n" +
            "- Reset data\n" +
            "- Show all players\n" +
            "- What is Alice’s score?\n\n" +

            "🏆 **Rankings**\n" +
            "- Who is the leader?\n" +
            "- Who is in last place?\n" +
            "- Top 3 players\n" +
            "- Rank of Bob\n" +
            "- Difference between top 2\n" +
            "- Compare Alice and Bob\n\n" +

            "📊 **Statistics**\n" +
            "- Total score\n" +
            "- Average score\n" +
            "- Median score\n" +
            "- Range of scores\n" +
            "- Who has more than 50 points?\n\n" +

            "⚔️ **Special**\n" +
            "- Win margin (double)\n" +
            "- Gap between players\n\n" +

            "💡 Tip: Just type what you want, e.g., 'Show top 5 players'.";

    if (message.includes("add player")) 
        return "➕ Click 'Add Player', enter details, then press 'Add'.";
    
    if (message.includes("update score")) 
        return "📝 Click 'Update Score', enter ID and change, then press 'Update'.";
    
    if (message.includes("reset")) 
        return "🗑️ Use 'Reset All Data' to clear everything.";
    
    if (message.includes("rules")) 
        return "🏆 Scores are ranked, top 3 get medals 🥇🥈🥉.";

    // Leader
    if (message.includes("leader") || message.includes("top scorer")) {
        if (players.length === 0) return "⚠️ No players yet.";
        let top = [...players].sort((a, b) => b.score - a.score)[0];
        return `🥇 Current Leader:\n${top.name} — ${top.score.toLocaleString()} points`;
    }

    // Lowest
    if (message.includes("lowest") || message.includes("last place")) {
        if (players.length === 0) return "⚠️ No players yet.";
        let low = [...players].sort((a, b) => a.score - b.score)[0];
        return `⬇️ Lowest Scorer:\n${low.name} — ${low.score.toLocaleString()} points`;
    }

    // Average
    if (message.includes("average") || message.includes("mean")) {
        if (players.length === 0) return "⚠️ No players yet.";
        let avg = players.reduce((sum, p) => sum + p.score, 0) / players.length;
        return `📊 Average Score:\n${avg.toFixed(2)}`;
    }

    // Median
    if (message.includes("median")) {
        if (players.length === 0) return "⚠️ No players yet.";
        let sortedScores = [...players].map(p => p.score).sort((a, b) => a - b);
        let mid = Math.floor(sortedScores.length / 2);
        let median = (sortedScores.length % 2 !== 0) ?
                    sortedScores[mid] :
                    (sortedScores[mid - 1] + sortedScores[mid]) / 2;
        return `📈 Median Score:\n${median}`;
    }

    // Total
    if (message.includes("total") || message.includes("sum")) {
        return `💰 Total Team Score:\n${totalScore.toLocaleString()}`;
    }

    // Range
    if (message.includes("range") || message.includes("spread")) {
        if (players.length === 0) return "⚠️ No players yet.";
        let max = Math.max(...players.map(p => p.score));
        let min = Math.min(...players.map(p => p.score));
        return `📏 Score Range:\nLowest: ${min}\nHighest: ${max}`;
    }

    // Player list
    if (message.includes("players") || message.includes("list")) {
        if (players.length === 0) return "⚠️ No players yet.";
        let response = "👥 All Players:\n";
        players.forEach((p, i) => {
        response += `${i + 1}. ${p.name} — ${p.score.toLocaleString()}\n`;
        });
        return response.trim();
    }

    // Difference between top 2
    if (message.includes("difference") || message.includes("gap")) {
        if (players.length < 2) return "⚠️ Not enough players to compare.";
        let sorted = [...players].sort((a, b) => b.score - a.score);
        let gap = sorted[0].score - sorted[1].score;
        return `📊 Gap:\n${sorted[0].name} leads ${sorted[1].name} by ${gap} points`;
    }

    // Double margin
    if (message.includes("double") || message.includes("win margin")) {
        if (players.length < 2) return "⚠️ Not enough players.";
        let sorted = [...players].sort((a, b) => b.score - a.score);
        let need = (sorted[1].score * 2) - sorted[0].score + 1;
        return `🏆 Win Margin:\n${sorted[0].name} needs ${need} more points to double ${sorted[1].name}`;
    }

    // Top N players
    if (message.includes("top")) {
        let num = parseInt(message.match(/\d+/));
        if (isNaN(num)) num = 3;
        let sorted = [...players].sort((a, b) => b.score - a.score).slice(0, num);
        if (sorted.length === 0) return "⚠️ No players yet.";

        let response = `🏅 Top ${sorted.length} Players:\n`;
        sorted.forEach((p, i) => {
        let medal = i === 0 ? "🥇 " : i === 1 ? "🥈 " : i === 2 ? "🥉 " : "";
        response += `${medal}${i + 1}. ${p.name} — ${p.score.toLocaleString()}\n`;
        });
        return response.trim();
    }

    // More than N points
    if (message.includes("more than")) {
        let num = parseInt(message.match(/\d+/));
        if (isNaN(num)) return "⚠️ Please specify a number, e.g., 'more than 50'.";
        let filtered = players.filter(p => p.score > num);
        if (filtered.length === 0) return `⚠️ No players have more than ${num} points.`;
        let response = `📊 Players with more than ${num} points:\n`;
        filtered.forEach((p, i) => {
        response += `${i + 1}. ${p.name} — ${p.score.toLocaleString()}\n`;
        });
        return response.trim();
    }

    // Rank of a player
    if (message.includes("rank")) {
        let foundPlayer = players.find(p => message.includes(p.name.toLowerCase()));
        if (!foundPlayer) return "⚠️ Please specify a valid player name.";
        let sorted = [...players].sort((a, b) => b.score - a.score);
        let rank = sorted.findIndex(p => p.id === foundPlayer.id) + 1;
        return `📌 ${foundPlayer.name}'s Rank:\n#${rank} — ${foundPlayer.score.toLocaleString()} points`;
    }

    // Shortcuts for dashboard actions
    // Add player via chat
    if (message.startsWith("/add")) {
        // Try matching format: /add name=John score=20
        let nameMatch = message.match(/name=(\w+)/i);
        let scoreMatch = message.match(/score=(-?\d+)/i);

        // If that fails, try matching format: /add John 20
        if (!nameMatch || !scoreMatch) {
            const parts = message.split(" ");
            if (parts.length === 3) {
                nameMatch = [null, parts[1]];   // fake match array for consistency
                scoreMatch = [null, parts[2]];
            }
        }
        if (!nameMatch) return "⚠️ Please provide a name, e.g., /add name=Alice score=50";
        let name = nameMatch[1];
        let score = scoreMatch ? parseInt(scoreMatch[1]) : 0;

        let newPlayer = { id: playerIdCounter++, name: name, score: score };
        players.push(newPlayer);
        totalScore += score;
        saveAndUpdate();

        return `➕ Player added: ${name} — ${score} points (ID: ${newPlayer.id})`;
    }

    // Update score via chat
    if (message.startsWith("/update")) {
        let idMatch = message.match(/id=(\d+)/i);
        let scoreMatch = message.match(/score=(-?\d+)/i);

        // If that fails, try matching format: /update 1 20
        if (!idMatch || !scoreMatch) {
            const parts = message.split(" ");
            if (parts.length === 3) {
                idMatch = [null, parts[1]];     // fake match array for consistency
                scoreMatch = [null, parts[2]];
            }
        }

        if (!idMatch || !scoreMatch) 
            return "⚠️ Please provide ID and score, e.g., /update id=1 score=20";

        let playerId = parseInt(idMatch[1]);
        let scoreChange = parseInt(scoreMatch[1]);
        let player = players.find(p => p.id === playerId);
        if (!player) return "⚠️ Player not found.";

        player.score += scoreChange;
        totalScore += scoreChange;
        saveAndUpdate();

        return `📝 Updated: ${player.name} now has ${player.score} points`;
    }

    // Adjust total score via chat
    if (message.startsWith("/adjust")) {
        const totalMatch = message.match(/total=(-?\d+)/i);
        if (!totalMatch) return "⚠️ Please provide total, e.g., /adjust total=500";

        totalScore = parseInt(totalMatch[1]);
        saveAndUpdate();

        return `⚙️ Total score updated to ${totalScore}`;
    }



    if (message.startsWith("/dashboard")) {
        showDashboard();
        return "✨ Dashboard view enabled!";
    }

    if (message.startsWith("/reset")) {
        resetData();
        return "🗑️ All data has been reset!";
    }

    if (message.startsWith("/light")) {
        applyTheme("light");
        return "🌞 Light Mode enabled!";
    }

    if (message.startsWith("/dark")) {
        applyTheme("dark");
        return "🌙 Dark Mode enabled!";
    }


    // Comparison between two players (must come BEFORE single-player check)
    let mentioned = players.filter(p => message.includes(p.name.toLowerCase()));
    if (mentioned.length === 2) {
    let [p1, p2] = mentioned;
    if (p1.score > p2.score) {
        return `⚔️ Comparison:\n${p1.name} — ${p1.score.toLocaleString()}\n${p2.name} — ${p2.score.toLocaleString()}\n➡️ ${p1.name} is ahead`;
    }
    if (p2.score > p1.score) {
        return `⚔️ Comparison:\n${p1.name} — ${p1.score.toLocaleString()}\n${p2.name} — ${p2.score.toLocaleString()}\n➡️ ${p2.name} is ahead`;
    }
    return `⚔️ Comparison:\n${p1.name} and ${p2.name} are tied at ${p1.score.toLocaleString()} points each.`;
    }

    // Player-specific lookup (after comparison logic)
    let foundPlayer = players.find(p => message.includes(p.name.toLowerCase()));
    if (foundPlayer) {
    return `ℹ️ ${foundPlayer.name}:\nScore: ${foundPlayer.score.toLocaleString()}`;
    }


    return "❓ Sorry, I don't understand. Try 'help'.";
    }




  // Chat Panel toggle
  const chatIcon = document.getElementById("chatIcon");
  const chatPanel = document.getElementById("chatPanel");
  const minimizeChat = document.getElementById("minimizeChat");
  const closeChat = document.getElementById("closeChat");
  const chatbox = document.getElementById("chatbox");

    // Click handler
    chatIcon.addEventListener("click", () => {
        createSmoke(() => {
            chatPanel.classList.add("show");
        });
        chatIcon.style.display = "none";
    });


    // Close chat
    closeChat.addEventListener("click", closeChatWithPuff);

    // Minimize chat
    minimizeChat.addEventListener("click", closeChatWithPuff);



    // Theme toggle
    const themeToggle = document.getElementById("themeToggle");

    function applyTheme(mode) {
    if (mode === "dark") {
        document.body.classList.add("dark-mode");
        themeToggle.textContent = "🌞 Light Mode";
    } else {
        document.body.classList.remove("dark-mode");
        themeToggle.textContent = "🌙 Dark Mode";
    }
    localStorage.setItem("theme", mode);
    }

    // Load saved theme
    const savedTheme = localStorage.getItem("theme") || "light";
    applyTheme(savedTheme);

    themeToggle.addEventListener("click", () => {
    const newTheme = document.body.classList.contains("dark-mode") ? "light" : "dark";
    applyTheme(newTheme);
    });


  updatePlayers();
</script>
</body>
</html>